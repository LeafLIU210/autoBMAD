# 质量保证流程详细说明

**版本**: 1.0
**最后更新**: 2026-01-22

---

## 目录

1. [质量保证概述](#1-质量保证概述)
2. [QA命令参考](#2-qa命令参考)
3. [完整QA工作流](#3-完整qa工作流)
4. [理解门控决策](#4-理解门控决策)
5. [风险评分策略](#5-风险评分策略)
6. [特殊情况和最佳实践](#6-特殊情况和最佳实践)
7. [自动化工作流集成](#7-自动化工作流集成)

---

## 1. 质量保证概述

### 1.1 Test Architect集成

Test Architect (QA代理)在整个开发生命周期中提供全面的质量保证。

### 1.2 核心理念

质量保证不是最后的检查点，而是贯穿整个开发过程的持续活动：

- **预防胜于治疗**: 在开发早期发现和预防缺陷
- **自动化优先**: 使用工具自动化质量检查
- **持续改进**: 基于反馈不断优化流程

---

## 2. QA命令参考

| 阶段 | 命令 | 目的 | 输出 | 优先级 |
|------|------|------|------|--------|
| **故事批准后** | `*risk` | 识别集成和回归风险 | 风险评估报告 | 复杂/遗留项目高优先级 |
| | `*design` | 为开发者创建测试策略 | 测试设计文档 | 新功能高优先级 |
| **开发期间** | `*trace` | 验证测试覆盖 | 覆盖跟踪报告 | 中等 |
| | `*nfr` | 验证质量属性 | NFR评估报告 | 关键功能高优先级 |
| **开发后** | `*review` | 综合评估 | 审查结果和QA门控 | **必需** |
| **审查后** | `*gate` | 更新质量决策 | 更新的QA门控 | 根据需要 |

### 2.1 命令详细说明

#### *risk (风险评估)
- **时机**: 故事批准后，开发开始前
- **目标**: 识别技术债务影响、集成复杂性、回归可能性
- **输出**: 1-9风险评分
- **使用场景**: 复杂故事、遗留代码集成

#### *design (测试设计)
- **时机**: 故事批准后，*risk之后
- **目标**: 为开发者创建测试策略
- **输出**: 每个验收标准的测试场景、测试级别建议、风险优先级
- **使用场景**: 新功能开发

#### *trace (需求跟踪)
- **时机**: 开发期间，中期检查点
- **目标**: 验证所有验收标准都有测试覆盖
- **输出**: 覆盖跟踪报告
- **使用场景**: 验证无缺失测试场景

#### *nfr (非功能需求)
- **时机**: 开发期间，关键里程碑
- **目标**: 评估安全性、性能、可靠性、可维护性
- **输出**: NFR评估报告
- **使用场景**: 性能关键功能

#### *review (综合审查)
- **时机**: 开发完成后，故事审查阶段
- **目标**: 全面的测试架构审查
- **输出**: 审查结果和QA门控决策
- **使用场景**: 所有故事的标准流程

#### *gate (质量门控)
- **时机**: 审查后，解决Issue后
- **目标**: 更新质量决策
- **输出**: 更新的QA门控状态
- **使用场景**: 根据需要

---

## 3. 完整QA工作流

### 3.1 阶段1: 故事创建后（开发开始前）

#### 推荐流程 - 为开发者奠定成功基础

**步骤1: 风险评估（复杂故事优先运行）**
```bash
@qa *risk {approved-story}
```
- **输出**: 风险评估报告
- **内容**: 技术债务影响、集成复杂性、回归可能性(1-9评分)
- **建议**: 高风险(≥6)的故事需要特别关注

**步骤2: 测试设计（第二个运行以指导实现）**
```bash
@qa *design {approved-story}
```
- **输出**: 测试设计文档
- **内容**: 每个验收标准的测试场景、测试级别建议、风险优先级
- **价值**: 为开发者提供明确的测试指导

### 3.2 阶段2: 开发期间（中期实现检查点）

#### 开发者自助质量检查

**步骤3: 需求跟踪（开发中期验证覆盖）**
```bash
@qa *trace {story-in-progress}
```
- **输出**: 覆盖跟踪报告
- **验证**: 所有验收标准都有测试、无缺失测试场景
- **价值**: 确保测试完整性

**步骤4: NFR验证（检查质量属性）**
```bash
@qa *nfr {story-in-progress}
```
- **输出**: NFR评估报告
- **评估**: 安全性、性能、可靠性、可维护性
- **价值**: 确保非功能需求得到满足

### 3.3 阶段3: 故事审查（质量门控评估）

#### 必需 - 全面的测试架构审查

**步骤5: 完整审查（标准审查流程）**
```bash
@qa *review {completed-story}
```

#### 审查期间发生什么

1. **深度代码分析**
   - 架构模式合规性
   - 代码质量和可维护性
   - 代码复杂度分析

2. **主动重构**
   - 直接改进代码
   - 修复明显问题
   - 优化性能瓶颈

3. **测试验证**
   - 所有级别的覆盖（单元、集成、系统）
   - 测试质量评估
   - 回归测试充分性

4. **门控决策**
   - 创建QA门控文件
   - 添加QA结果部分
   - 决策后续流程

### 3.4 阶段4: 审查后（解决Issue后）

#### 解决Issue后更新门控状态

**步骤6: 门控更新（记录最终决策）**
```bash
@qa *gate {reviewed-story}
```
- **输出**: 具有新状态的质量门控
- **价值**: 记录最终决策和理由

---

## 4. 理解门控决策

### 4.1 门控状态

| 状态 | 含义 | 需要采取的行动 | 可以继续吗？ |
|------|------|----------------|--------------|
| **PASS** | 所有关键要求都满足 | 无 | ✅ 是 |
| **CONCERNS** | 发现非关键问题 | 建议团队审查 | ⚠️ 谨慎进行 |
| **FAIL** | 发现关键问题（安全性、缺失P0测试） | 必须修复 | ❌ 否 |
| **WAIVED** | 问题已被确认和接受 | 记录理由 | ✅ 批准后可以 |

### 4.2 决策逻辑

#### PASS (通过)
- **条件**: 所有P0测试通过，代码质量合格，无关键问题
- **后续**: 故事可以标记为完成
- **要求**: 记录通过理由

#### CONCERNS (关注)
- **条件**: 发现非关键问题，但不影响核心功能
- **后续**: 建议修复，但不是强制
- **要求**: 详细记录关注点和建议

#### FAIL (失败)
- **条件**: 发现关键问题，如安全漏洞、缺失P0测试
- **后续**: 必须修复才能继续
- **要求**: 明确指出问题和修复要求

#### WAIVED (豁免)
- **条件**: 问题已被确认和接受
- **后续**: 可以继续，但需要记录理由
- **要求**: 详细记录豁免理由和影响

---

## 5. 风险评分策略

### 5.1 评分计算

风险评分 = 发生概率 × 影响程度

| 风险评分 | 计算 | 测试优先级 | 门控影响 |
|----------|------|------------|----------|
| **9** | 高概率 × 高影响 | P0 - 必须彻底测试 | 如果未测试则FAIL |
| **6** | 中高组合 | P1 - 应该很好地测试 | 如果有差距则CONCERNS |
| **4** | 中等组合 | P1 - 应该测试 | 如果有明显差距则CONCERNS |
| **2-3** | 中低组合 | P2 - 有更好 | 在审查中记录 |
| **1** | 最小风险 | P2 - 最小 | 在审查中记录 |

### 5.2 风险类型

#### 技术风险
- 代码复杂度
- 技术债务
- 依赖关系

#### 集成风险
- API兼容性
- 数据一致性
- 系统交互

#### 性能风险
- 响应时间
- 吞吐量
- 资源消耗

#### 安全风险
- 数据泄露
- 权限控制
- 输入验证

### 5.3 风险应对策略

#### 高风险(7-9)
- **策略**: 预防为主
- **测试**: 全面的测试策略
- **审查**: 多次审查
- **门控**: 严格门控

#### 中风险(4-6)
- **策略**: 平衡投入
- **测试**: 适当的测试覆盖
- **审查**: 标准审查
- **门控**: 标准门控

#### 低风险(1-3)
- **策略**: 接受并监控
- **测试**: 基本测试
- **审查**: 简化审查
- **门控**: 宽松门控

---

## 6. 特殊情况和最佳实践

### 6.1 高风险或Brownfield故事

#### 推荐序列
```bash
@qa *risk {story}    # 首先 - 识别危险
@qa *design {story}  # 第二 - 规划防御
# 然后在开发期间：
@qa *trace {story}   # 验证回归覆盖
@qa *nfr {story}     # 检查性能影响
# 最后：
@qa *review {story}  # 深度集成分析
```

#### 重点关注
- 回归测试充分性
- 集成测试覆盖
- 性能影响评估

### 6.2 复杂集成

#### 关键策略
- 在开发期间多次运行`*trace`
- 关注集成测试覆盖
- 使用`*nfr`验证跨系统性能
- 特别注意API合同的审查

#### 集成测试类型
- **契约测试**: 验证API兼容性
- **数据一致性测试**: 验证数据同步
- **端到端测试**: 验证完整业务流程

### 6.3 性能关键功能

#### 最佳实践
- 尽早并经常运行`*nfr`（不仅仅是审查时）
- 在更改前建立性能基线
- 记录可接受的性能退化
- 在`*design`中考虑负载测试要求

#### 性能指标
- **响应时间**: P95 < 200ms
- **吞吐量**: 支持预期负载
- **资源消耗**: CPU/内存使用合理

### 6.4 安全关键功能

#### 强制要求
- 所有安全功能必须通过安全审查
- 输入验证和输出编码必须测试
- 权限控制必须全面测试
- 敏感数据处理必须符合规范

---

## 7. 自动化工作流集成

### 7.1 工具链概览

项目集成了三个专业工作流工具，形成完整的自动化质量保证体系：

1. **BMAD-Workflow** - 自动化质量门控
2. **BasedPyright-Workflow** - 代码质量检查
3. **Fixtest-Workflow** - 测试质量保证

### 7.2 BMAD-Workflow质量门控

#### 质量门控状态

| 状态 | 含义 | 后续操作 | 是否可继续 |
|------|------|----------|------------|
| **PASS** | 所有关键要求满足 | 无 | ✅ 是 |
| **CONCERNS** | 发现非关键问题 | 进入Phase C修复 | ⚠️ 谨慎进行 |
| **FAIL** | 发现关键问题 | 必须修复 | ❌ 否 |
| **WAIVED** | 问题已被确认和接受 | 记录理由 | ✅ 批准后可以 |

#### 自动化流程
```
Phase A (开发) → Phase B (QA审查) → 质量门控决策
                     ↓
              根据结果进入不同路径
                     ↓
    ┌─────────────┬─────────────┬─────────────┐
    ↓             ↓             ↓             ↓
  PASS          CONCERNS       FAIL        WAIVED
    ↓             ↓             ↓             ↓
Phase D        Phase C       Phase C      完成
(最终开发)    (修复开发)    (修复开发)
```

#### 门控决策因素
1. **测试覆盖率**: P0测试必须100%通过
2. **代码质量**: 基于pyright类型检查无ERROR
3. **代码风格**: Ruff检查无严重违规
4. **安全性**: 无安全漏洞或已处理
5. **性能**: NFR评估满足要求

#### 使用示例
```bash
# 执行完整的autoBMAD工作流
python -m autoBMAD.epic_automation.epic_driver docs/epics/my-epic.md --verbose

# 跳过质量门控
python -m autoBMAD.epic_automation.epic_driver docs/epics/my-epic.md --skip-quality
```

### 7.3 autoBMAD工作流质量保证

autoBMAD系统集成了完整的质量保证流程：

#### 质量检查维度

1. **类型安全**:
   - 基于pyright的静态类型检查
   - 检测类型不匹配、推断错误
   - 生成类型覆盖率报告

2. **代码风格**:
   - Ruff规则检查和自动修复
   - PEP 8合规性
   - 代码复杂度分析

3. **错误分类**:
   - ERROR: 严重问题，必须修复
   - WARNING: 潜在问题，建议修复
   - INFO: 提示信息，可选处理

#### 执行工作流
```bash
# 完整质量检查流程
python -m autoBMAD.epic_automation.epic_driver docs/epics/my-epic.md --verbose

# 单独运行BasedPyright
basedpyright src/

# 单独运行Ruff检查
ruff check --fix src/

# 单独运行Ruff格式化
ruff format src/
```

#### 报告示例
```markdown
# BasedPyright 检查报告

## 执行摘要
- 检查文件: 89个
- 错误数量: 886个
- 警告数量: 7158个
- 检查耗时: 7.08秒

## 错误详情
[按文件和规则分组的详细列表]

## 质量趋势
- 错误趋势: ↓ 12%
- 类型覆盖率: 85%
- 风格合规率: 92%
```

### 7.4 Pytest测试质量保证

#### 测试质量指标

1. **测试覆盖**:
   - 单元测试覆盖率
   - 集成测试覆盖率
   - GUI测试覆盖率

2. **测试健康度**:
   - 通过率: >95%
   - 平均执行时间: <5秒
   - 超时率: <1%

3. **错误分布**:
   - ERROR: 导入错误、配置错误
   - FAIL: 断言失败、业务逻辑错误
   - TIMEOUT: 性能问题、死锁

#### 执行流程
```bash
# 1. 运行所有测试
pytest tests/ -v

# 2. 生成覆盖率报告
pytest tests/ --cov=src --cov-report=html

# 3. 运行特定测试文件
pytest tests/test_my_feature.py -v

# 4. 通过autoBMAD自动执行
python -m autoBMAD.epic_automation.epic_driver docs/epics/my-epic.md
```

#### 测试结果摘要
```json
{
    "timestamp": "20260104_143045",
    "total_files": 45,
    "executed_files": 45,
    "passed_files": 33,
    "files_with_errors": 12,
    "error_summary": {
        "ERROR": 8,
        "FAIL": 3,
        "TIMEOUT": 1
    },
    "total_errors": 24
}
```

### 7.5 工具链集成策略

#### 完整质量保证流程
```
autoBMAD 5阶段工作流
    ↓
Phase 1: SM-Dev-QA循环 (故事开发)
    ↓
Phase 2: 质量门控
├── Ruff Check (代码风格)
├── BasedPyright (类型检查)
└── Ruff Format (格式化)
    ↓
Phase 3: 测试自动化 (Pytest)
    ↓
Phase 4: 编排管理
    ↓
Phase 5: 文档与测试
    ↓
质量门控决策 → [PASS/CONCERNS/FAIL/WAIVED]
```

### 7.6 质量门控决策矩阵

| 工具 | 检查维度 | 门控影响 | 重试次数 |
|------|----------|----------|----------|
| **Ruff** | 代码风格、导入排序 | 质量门控 | 3次 |
| **BasedPyright** | 类型安全、静态分析 | 质量门控 | 3次 |
| **Pytest** | 测试质量、覆盖率 | 测试门控 | 5次 |

#### 决策逻辑
- **全绿** (全部PASS): ✅ 可以继续
- **1个黄灯** (1个CONCERNS): ⚠️ 谨慎继续，优先修复
- **1个红灯** (1个FAIL): ❌ 必须修复
- **多个黄灯** (≥2个CONCERNS): ❌ 必须修复
- **任意红灯** (任意FAIL): ❌ 必须修复

### 7.7 质量度量体系

#### 度量指标

1. **代码质量指标**:
   - 类型覆盖率: >80%
   - 风格合规率: >90%
   - 复杂度: <10 (圈复杂度)

2. **测试质量指标**:
   - 测试通过率: >95%
   - 测试覆盖率: >80%
   - 平均执行时间: <5秒

3. **流程质量指标**:
   - 门控通过率: >85%
   - 修复周期: <2小时
   - 缺陷密度: <1/千行代码

#### 报告示例
```markdown
# 质量度量报告

## 代码质量
- 类型覆盖率: 85% ✅
- 风格合规率: 92% ✅
- 复杂度: 7.2 ✅

## 测试质量
- 测试通过率: 96% ✅
- 测试覆盖率: 82% ✅
- 平均执行时间: 3.8秒 ✅

## 流程质量
- 门控通过率: 88% ✅
- 平均修复周期: 1.5小时 ✅
- 缺陷密度: 0.8/千行 ✅

## 总体评估
质量等级: A (优秀)
建议: 保持当前质量标准
```

---

## 最佳实践总结

### 1. 质量保证原则
- **预防优先**: 早期发现问题
- **自动化为主**: 减少手工检查
- **持续改进**: 基于反馈优化

### 2. 工具使用
- BMAD-Workflow用于整体流程控制
- BasedPyright用于代码质量检查
- Fixtest-Workflow用于测试质量保证

### 3. 团队协作
- 开发者：编写高质量代码和测试
- QA：执行全面审查和门控决策
- 团队：共同维护质量标准

### 4. 持续改进
- 定期审查质量门控决策
- 分析质量度量数据
- 优化开发流程

---

**参考文档**:
- [BMAD开发方法论](./bmad_methodology.md)
- [工作流工具集](./workflow_tools.md)
- [测试指南](./testing_guide.md)

---

**版本历史**:
- v1.0 (2026-01-04): 初始版本，完整的质量保证流程说明
