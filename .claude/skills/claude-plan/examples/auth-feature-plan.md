# 用户认证功能实施计划

## 功能概述
为 FastAPI 应用添加完整的用户认证系统，支持 JWT 令牌和刷新令牌机制。

## 背景与动机
- **业务目标**: 实现安全的用户身份验证，保护需要授权的 API 端点
- **用户价值**: 用户可以安全登录访问个人数据，系统可以验证用户身份
- **现有状态**: 目前所有 API 都是公开的，没有用户概念和权限控制

## 技术约束
- 使用 JWT 作为认证机制
- 令牌需要刷新机制以平衡安全性和用户体验
- 需要支持密码加密存储
- 集成现有的 SQLAlchemy ORM

## 实施任务

### 任务 1: 数据模型设计
- [ ] 步骤 1.1：设计 User 模型（用户名、邮箱、密码哈希等）
- [ ] 步骤 1.2：设计 RefreshToken 模型（刷新令牌存储）
- [ ] 步骤 1.3：创建数据库迁移脚本
- 📁 涉及文件：`models/user.py`, `alembic/versions/xxx_add_user_table.py`

### 任务 2: 认证逻辑实现
- [ ] 步骤 2.1：实现密码加密/验证工具函数
- [ ] 步骤 2.2：实现 JWT 令牌生成和验证
- [ ] 步骤 2.3：实现刷新令牌生成和存储
- 📁 涉及文件：`utils/auth.py`, `core/security.py`

### 任务 3: API 端点开发
- [ ] 步骤 3.1：实现用户注册 API
- [ ] 步骤 3.2：实现用户登录 API（返回 JWT 和刷新令牌）
- [ ] 步骤 3.3：实现刷新令牌 API
- [ ] 步骤 3.4：实现用户信息查询 API
- 📁 涉及文件：`api/auth.py`

### 任务 4: 中间件和依赖
- [ ] 步骤 4.1：实现认证依赖（验证 JWT）
- [ ] 步骤 4.2：实现用户依赖（从令牌获取用户信息）
- [ ] 步骤 4.3：创建依赖注入容器
- 📁 涉及文件：`api/deps.py`, `core/dependencies.py`

### 任务 5: 受保护路由示例
- [ ] 步骤 5.1：更新现有 API 使用认证依赖
- [ ] 步骤 5.2：测试受保护的端点
- 📁 涉及文件：`api/items.py`

## 依赖关系
- 任务 2 依赖 任务 1 完成
- 任务 4 依赖 任务 2 完成
- 任务 5 依赖 任务 4 完成
- 需要安装 PyJWT 依赖包

## 风险评估
| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 密码存储不当 | Low | High | 使用 bcrypt 进行哈希 |
| JWT 令牌泄露 | Medium | High | 设置合理过期时间，使用 HTTPS |
| 刷新令牌被滥用 | Medium | Medium | 限制刷新令牌数量，撤销机制 |

## 测试策略
- **单元测试**: 测试认证工具函数、JWT 生成验证
- **集成测试**: 测试完整登录流程、令牌刷新流程
- **端到端测试**: 测试受保护 API 端点访问

## 预估工作量
- 总体复杂度：High
- 预估时间：5-7 天
- 涉及代码行数：约 800-1200 行

## 文件修改清单
```
models/user.py      # 新增：User 数据模型
models/token.py     # 新增：RefreshToken 数据模型
utils/auth.py       # 新增：认证工具函数
core/security.py    # 新增：JWT 处理逻辑
api/auth.py         # 新增：认证相关 API 端点
api/deps.py         # 新增：认证依赖
alembic/versions/xxx_add_user_table.py  # 新增：数据库迁移
api/items.py        # 修改：添加认证依赖
requirements.txt    # 修改：添加依赖包
```

## 验收标准
- [ ] 用户可以通过邮箱和密码注册新账户
- [ ] 用户可以通过邮箱和密码登录获得 JWT 令牌
- [ ] 使用有效 JWT 令牌可以访问受保护的 API
- [ ] JWT 过期后可以通过刷新令牌获得新令牌
- [ ] 未认证用户无法访问受保护的 API
- [ ] 通过所有单元测试和集成测试

## 后续工作
- [ ] 添加密码重置功能
- [ ] 添加社交登录（OAuth）
- [ ] 添加用户权限管理（RBAC）
- [ ] 添加登录日志和审计

## 批准
[ ] 我已审阅计划，批准执行

---
*生成时间: 2026-01-19*
