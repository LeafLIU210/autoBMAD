# Story 003.1: Ruff Agent Integration

**Epic Reference**: [Epic-003: Quality Gates Integration](../epics/epic-003-quality-gates-sprint.md)

---

## Status
**Status**: Approved
**Priority**: High
**Estimated Effort**: 2 days
**Assigned To**: Dev Agent

---

## Story

**As a** BMAD automation system,
**I want to** integrate ruff code linting with auto-fix capabilities,
**so that** code quality can be validated and automatically corrected after QA completion.

---

## Acceptance Criteria

- [ ] Ruff added as pip dependency
- [ ] CodeQualityAgent class created
- [ ] Ruff execution: `ruff check --fix --output-format=json {source_dir}`
- [ ] JSON error parsing implemented
- [ ] Claude SDK fixes for identified issues (using max_turns=150, no external timeouts)
- [ ] Max 3 cycles with 2 retries each (no asyncio.wait_for or asyncio.shield)
- [ ] Virtual environment: venv\\Scripts
- [ ] Zero Cancel Scope errors in implementation

---

## Tasks / Subtasks

- [ ] Task 1: Add ruff dependency to project
  - [ ] Subtask 1.1: Update pyproject.toml with ruff dependency
  - [ ] Subtask 1.2: Install ruff in virtual environment

- [ ] Task 2: Create CodeQualityAgent class
  - [ ] Subtask 2.1: Design agent architecture for ruff integration
  - [ ] Subtask 2.2: Implement ruff execution method
  - [ ] Subtask 2.3: Implement JSON parsing for ruff output

- [ ] Task 3: Implement ruff check and fix workflow
  - [ ] Subtask 3.1: Execute `ruff check --fix --output-format=json {source_dir}`
  - [ ] Subtask 3.2: Parse JSON output for errors and warnings
  - [ ] Subtask 3.3: Integrate Claude SDK for automated fixes

- [ ] Task 4: Implement retry logic
  - [ ] Subtask 4.1: Create retry mechanism (max 3 cycles, 2 retries each)
  - [ ] Subtask 4.2: Add exponential backoff for retries
  - [ ] Subtask 4.3: Track fix attempts and results

- [ ] Task 5: Test and validate
  - [ ] Subtask 5.1: Create unit tests for CodeQualityAgent
  - [ ] Subtask 5.2: Test ruff integration with sample code
  - [ ] Subtask 5.3: Verify virtual environment activation (venv\\Scripts)

---

## Dev Notes

### Epic-003 Integration Context
This story is the first in a 5-story sequence implementing quality gates after `execute_dev_qa_cycle()` completes. Ruff comes first in the sequential pipeline: Ruff → Basedpyright → Pytest.

### Technical Architecture
- **Class Location**: Create in `autoBMAD/epic_automation/quality_agents.py`
- **Virtual Environment**: Use `venv\\Scripts` for Windows compatibility
- **JSON Output Format**: Essential for programmatic error parsing
- **Claude SDK Integration**: For automated fix generation

### CodeQualityAgent Design Pattern
```python
class CodeQualityAgent:
    def __init__(self, tool_name, command_template):
        self.tool_name = tool_name
        self.command_template = command_template

    def execute_check(self, source_dir):
        # Execute tool with JSON output
        # Parse results
        # Return structured data

    def fix_issues(self, issues):
        # Use Claude SDK to generate fixes
        # Apply fixes to code
        # Return fix results

    def retry_cycle(self, max_cycles=3):
        # Implement retry logic
        # Track attempts and results
```

### Relevant Source Tree
- **Main Integration**: `autoBMAD/epic_automation/epic_driver.py` (will call this agent)
- **Agent Location**: `autoBMAD/epic_automation/quality_agents.py`
- **Virtual Environment**: `venv/Scripts/activate`

### Key Technical Details
1. **Command Execution**: Use subprocess to run ruff commands
2. **JSON Parsing**: Extract error/warning information from ruff JSON output
3. **SDK Integration**: Use Claude SDK with `max_turns=150` for fix suggestions (NO external timeouts)
4. **Cycle Management**: Track up to 3 fix cycles with 2 retries per cycle
5. **Environment**: Ensure proper venv activation for ruff execution

### ⚠️ Cancel Scope Safety Requirements
- **DO NOT use** `asyncio.wait_for()` or `asyncio.shield()` for SDK calls
- **DO use** `max_turns=150` in ClaudeAgentOptions for protection
- **NO external timeout mechanisms** - let SDK sessions complete naturally
- **Simple exception handling** - catch exceptions without external cancellation
- **Reference**: See `docs/evaluation/cancel-scope-error-analysis.md` for details

---

## Testing

### Testing Standards
- **Test File Location**: `tests/epic_automation/test_quality_agents.py`
- **Test Framework**: pytest
- **Test Coverage**: ≥90% for CodeQualityAgent class

### Test Requirements
1. **Unit Tests**:
   - Test ruff command execution
   - Test JSON output parsing
   - Test retry logic implementation
   - Test error handling

2. **Integration Tests**:
   - Test ruff integration with sample source code
   - Test complete fix cycle (check → fix → re-check)
   - Test max cycle limits
   - Test virtual environment activation

3. **Test Data**:
   - Create sample Python files with ruff violations
   - Include various linting errors (imports, formatting, complexity)
   - Verify auto-fix capabilities

---

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent during implementation_

### Completion Notes List
_This section will be populated by the development agent during implementation_

### File List
_This section will be populated by the development agent during implementation_

---

## QA Results

_This section will be populated by the QA agent during review_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.1 | Added Cancel Scope safety requirements - removed external timeouts, added SDK max_turns protection | Product Owner |
| 2026-01-07 | 1.0 | Initial story creation for Ruff Agent Integration | Scrum Master (Bob) |

---
