# Story 003.4: Epic Driver Orchestration

**Epic Reference**: [Epic-003: Quality Gates Integration](../epics/epic-003-quality-gates-sprint.md)

---

## Status
**Status**: Approved
**Priority**: High
**Estimated Effort**: 2 days
**Assigned To**: Dev Agent

---

## Story

**As a** BMAD automation system,
**I want to** extend epic_driver.py to orchestrate quality gates,
**so that** complete workflow executes seamlessly with proper error handling.

---

## Acceptance Criteria

- [ ] Quality gates integrate after execute_dev_qa_cycle()
- [ ] Sequential execution: Ruff → Basedpyright → Pytest
- [ ] CLI flags: --skip-quality, --skip-tests
- [ ] Progress tracking across all phases
- [ ] Error handling with clear feedback (no external timeouts)
- [ ] SDK protection only: max_turns=150 (NO asyncio.wait_for or asyncio.shield)
- [ ] Zero Cancel Scope errors in orchestration

---

## Tasks / Subtasks

- [ ] Task 1: Extend epic_driver.py for quality gates
  - [ ] Subtask 1.1: Add quality gates integration point after QA cycle
  - [ ] Subtask 1.2: Implement sequential agent orchestration
  - [ ] Subtask 1.3: Add progress tracking infrastructure

- [ ] Task 2: Implement CLI flags for quality gates
  - [ ] Subtask 2.1: Add --skip-quality flag (bypass ruff + basedpyright)
  - [ ] Subtask 2.2: Add --skip-tests flag (bypass pytest)
  - [ ] Subtask 2.3: Update CLI help text with new options

- [ ] Task 3: Implement sequential execution workflow
  - [ ] Subtask 3.1: Execute Ruff Agent after QA completion
  - [ ] Subtask 3.2: Execute Basedpyright Agent after Ruff success
  - [ ] Subtask 3.3: Execute Pytest Agent after Basedpyright success

- [ ] Task 4: Implement error handling (no external timeouts)
  - [ ] Subtask 4.1: Remove external timeout mechanisms
  - [ ] Subtask 4.2: Use SDK max_turns=150 for protection
  - [ ] Subtask 4.3: Implement simple error handling without asyncio.wait_for or asyncio.shield

- [ ] Task 5: Implement progress tracking
  - [ ] Subtask 5.1: Track progress through quality gates phases
  - [ ] Subtask 5.2: Display progress indicators to user
  - [ ] Subtask 5.3: Log detailed status for each phase

- [ ] Task 6: Test and validate
  - [ ] Subtask 6.1: Test complete workflow with all agents
  - [ ] Subtask 6.2: Test CLI flags functionality
  - [ ] Subtask 6.3: Test error handling and timeout scenarios

---

## Dev Notes

### Epic-003 Integration Context
This story orchestrates all three quality agents (Ruff, Basedpyright, Pytest) into the existing epic_automation workflow. It serves as the central coordinator for the quality gates pipeline.

### Technical Architecture
- **Main File**: `autoBMAD/epic_automation/epic_driver.py`
- **Integration Point**: After `execute_dev_qa_cycle()` returns True
- **Coordination**: Sequential execution with error handling and timeouts
- **CLI Integration**: New flags for optional quality gate bypass

### Epic Driver Enhancement Pattern
```python
def execute_quality_gates(epic_id, skip_quality=False, skip_tests=False):
    """Orchestrate quality gates pipeline after QA completion"""
    quality_gate = QualityGateOrchestrator()

    if not skip_quality:
        # Phase 1: Ruff Agent
        ruff_result = quality_gate.execute_ruff_agent(source_dir)
        if not ruff_result.success:
            quality_gate.retry_with_sdk_fixes(ruff_result, max_cycles=3)

        # Phase 2: Basedpyright Agent
        basedpyright_result = quality_gate.execute_basedpyright_agent(source_dir)
        if not basedpyright_result.success:
            quality_gate.retry_with_sdk_fixes(basedpyright_result, max_cycles=3)

    if not skip_tests:
        # Phase 3: Pytest Agent
        pytest_result = quality_gate.execute_pytest_agent(test_dir)
        if not pytest_result.success:
            quality_gate.retry_with_debugpy(pytest_result, max_cycles=3)

    return quality_gate.get_final_results()

def main():
    # Existing epic processing...
    if execute_dev_qa_cycle():
        # New quality gates integration
        quality_results = execute_quality_gates(
            epic_id,
            skip_quality=args.skip_quality,
            skip_tests=args.skip_tests
        )
```

### Relevant Source Tree
- **Main Orchestration**: `autoBMAD/epic_automation/epic_driver.py`
- **Agent Imports**:
  - `autoBMAD/epic_automation/quality_agents.py` (CodeQualityAgent)
  - `autoBMAD/epic_automation/test_automation_agent.py` (TestAutomationAgent)
- **Epic Processing**: Integration point in main epic processing loop

### Key Technical Details
1. **Activation Sequence**:
   - Epic Processing → QA Cycle → Quality Gates
   - Only triggers if QA cycle returns True
   - Sequential: Ruff → Basedpyright → Pytest

2. **CLI Integration**:
   - `--skip-quality`: Bypass ruff and basedpyright (test-only mode)
   - `--skip-tests`: Bypass pytest (quality-only mode)
   - Both flags can be used together (full bypass)

3. **SDK Protection** (Critical - No External Timeouts):
   - **Use max_turns=150** in ClaudeAgentOptions for all SDK calls
   - **NO asyncio.wait_for** - prevents cross-Task cancel scope errors
   - **NO asyncio.shield** - prevents scope nesting conflicts
   - **Let SDK complete naturally** - no external cancellation

4. **Error Handling**:
   - Simple exception catching without external timeout mechanisms
   - Clear error messages for user feedback
   - Continue execution if non-critical failures occur
   - Log detailed errors for debugging

### ⚠️ Cancel Scope Safety Requirements
- **CRITICAL**: Do NOT use `asyncio.wait_for()` or `asyncio.shield()` for any SDK calls
- **ONLY protection**: `max_turns=150` in ClaudeAgentOptions
- **Sequential execution**: Each agent completes before next starts (clear scope lifecycle)
- **Simple error handling**: Basic try/catch without external cancellation
- **Reference**: See `docs/evaluation/cancel-scope-error-analysis.md` for technical details

### Progress Tracking Implementation
- **Phase Indicators**: Show current quality gate (Ruff 1/3, Basedpyright 2/3, Pytest 3/3)
- **Cycle Tracking**: Display current cycle (1/3, 2/3, 3/3)
- **Success/Failure**: Clear pass/fail status for each agent
- **Time Tracking**: Show elapsed time for each phase

### Backward Compatibility
- **Existing Functionality**: 100% maintained
- **Optional Feature**: Quality gates are additive, not mandatory
- **Default Behavior**: Quality gates run by default
- **Migration Path**: Existing epics automatically get quality gates

---

## Testing

### Testing Standards
- **Test File Location**: `tests/epic_automation/test_epic_driver.py`
- **Test Framework**: pytest
- **Test Coverage**: ≥90% for epic_driver.py enhancements

### Test Requirements
1. **Unit Tests**:
   - Test quality gates orchestration logic
   - Test CLI flag parsing and handling
   - Test timeout configurations
   - Test error handling scenarios

2. **Integration Tests**:
   - Test complete workflow (QA → Quality Gates)
   - Test sequential agent execution
   - Test CLI flag bypass functionality
   - Test progress tracking display

3. **End-to-End Tests**:
   - Test full epic processing with quality gates
   - Test various flag combinations
   - Test error scenarios and recovery
   - Test timeout handling in real scenarios

### Special Testing Considerations
- **Agent Mocking**: Mock quality agents for integration tests
- **Timeout Testing**: Test timeout scenarios without actual delays
- **CLI Testing**: Test command-line flag parsing
- **Backward Compatibility**: Ensure existing workflows unaffected

---

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent during implementation_

### Completion Notes List
_This section will be populated by the development agent during implementation_

### File List
_This section will be populated by the development agent during implementation_

---

## QA Results

_This section will be populated by the QA agent during review_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.1 | CRITICAL UPDATE: Removed all external timeouts (1-min, 10-20 min), added Cancel Scope safety requirements, use SDK max_turns=150 only | Product Owner |
| 2026-01-07 | 1.0 | Initial story creation for Epic Driver Orchestration | Scrum Master (Bob) |

---
