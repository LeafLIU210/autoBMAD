# Story 003.2: Basedpyright Agent Integration

**Epic Reference**: [Epic-003: Quality Gates Integration](../epics/epic-003-quality-gates-sprint.md)

---

## Status
**Status**: Approved
**Priority**: High
**Estimated Effort**: 2 days
**Assigned To**: Dev Agent

---

## Story

**As a** BMAD automation system,
**I want to** integrate basedpyright type checking with validation,
**so that** code type safety can be verified and automatically corrected.

---

## Acceptance Criteria

- [ ] Basedpyright added as pip dependency
- [ ] Type checking execution: `basedpyright --outputjson {source_dir}`
- [ ] JSON error parsing implemented
- [ ] Claude SDK fixes for type errors (using max_turns=150, no external timeouts)
- [ ] Max 3 cycles with 2 retries each (no asyncio.wait_for or asyncio.shield)
- [ ] Integration with ruff agent workflow
- [ ] Zero Cancel Scope errors in implementation

---

## Tasks / Subtasks

- [ ] Task 1: Add basedpyright dependency to project
  - [ ] Subtask 1.1: Update pyproject.toml with basedpyright dependency
  - [ ] Subtask 1.2: Install basedpyright in virtual environment

- [ ] Task 2: Extend CodeQualityAgent for basedpyright
  - [ ] Subtask 2.1: Add basedpyright support to CodeQualityAgent class
  - [ ] Subtask 2.2: Implement basedpyright execution method
  - [ ] Subtask 2.3: Implement JSON parsing for basedpyright output

- [ ] Task 3: Implement basedpyright type check workflow
  - [ ] Subtask 3.1: Execute `basedpyright --outputjson {source_dir}`
  - [ ] Subtask 3.2: Parse JSON output for type errors
  - [ ] Subtask 3.3: Integrate Claude SDK for type error fixes

- [ ] Task 4: Implement sequential workflow integration
  - [ ] Subtask 4.1: Ensure basedpyright runs after ruff completion
  - [ ] Subtask 4.2: Handle ruff-modified code in basedpyright checks
  - [ ] Subtask 4.3: Maintain cycle tracking across agents

- [ ] Task 5: Test and validate
  - [ ] Subtask 5.1: Create unit tests for basedpyright integration
  - [ ] Subtask 5.2: Test type checking with sample code
  - [ ] Subtask 5.3: Verify sequential execution after ruff

---

## Dev Notes

### Epic-003 Integration Context
This story is the second in the quality gates pipeline. It executes after Ruff Agent completes successfully. The sequential pipeline: Ruff → **Basedpyright** → Pytest.

### Technical Architecture
- **Class Enhancement**: Extend `autoBMAD/epic_automation/quality_agents.py` CodeQualityAgent
- **Activation**: Triggered after ruff agent completion
- **JSON Output**: `--outputjson` flag for programmatic error parsing
- **Type Checking**: Strict type validation for Python code

### Basedpyright Integration Pattern
```python
class BasedpyrightAgent(CodeQualityAgent):
    def __init__(self):
        super().__init__(
            tool_name="basedpyright",
            command_template="basedpyright --outputjson {source_dir}"
        )

    def execute_type_check(self, source_dir):
        # Execute basedpyright with JSON output
        # Parse type errors
        # Return structured error data

    def generate_type_fixes(self, type_errors):
        # Use Claude SDK to suggest type annotations
        # Apply type hints to code
        # Return fix results
```

### Relevant Source Tree
- **Main Integration**: `autoBMAD/epic_automation/epic_driver.py` (calls this agent after ruff)
- **Agent Location**: `autoBMAD/epic_automation/quality_agents.py` (extends CodeQualityAgent)
- **Dependency**: Ruff must complete before basedpyright starts

### Key Technical Details
1. **Command Execution**: Use `basedpyright --outputjson {source_dir}` for JSON output
2. **Type Error Parsing**: Extract type annotation requirements from JSON
3. **SDK Integration**: Claude SDK with `max_turns=150` for type hints (NO external timeouts)
4. **Sequential Workflow**: Activates only after ruff agent success
5. **Cycle Management**: Independent 3-cycle retry system per agent

### ⚠️ Cancel Scope Safety Requirements
- **DO NOT use** `asyncio.wait_for()` or `asyncio.shield()` for SDK calls
- **DO use** `max_turns=150` in ClaudeAgentOptions for protection
- **NO external timeout mechanisms** - let SDK sessions complete naturally
- **Simple exception handling** - catch exceptions without external cancellation
- **Reference**: See `docs/evaluation/cancel-scope-error-analysis.md` for details

### Integration with Ruff
- **Code State**: Basedpyright works on ruff-modified code
- **Success Dependency**: Basedpyright only runs if ruff completes successfully
- **Error Handling**: Type errors may be introduced by ruff auto-fixes
- **Re-verification**: Each cycle re-checks after type fixes

---

## Testing

### Testing Standards
- **Test File Location**: `tests/epic_automation/test_quality_agents.py`
- **Test Framework**: pytest
- **Test Coverage**: ≥90% for BasedpyrightAgent class

### Test Requirements
1. **Unit Tests**:
   - Test basedpyright command execution
   - Test JSON output parsing for type errors
   - Test type fix generation
   - Test cycle management

2. **Integration Tests**:
   - Test sequential execution after ruff
   - Test type checking on ruff-modified code
   - Test complete type check cycle
   - Test error propagation between agents

3. **Test Data**:
   - Create sample Python files with type errors
   - Include missing type annotations
   - Include incorrect type hints
   - Verify type fix application

---

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_This section will be populated by the development agent during implementation_

### Completion Notes List
_This section will be populated by the development agent during implementation_

### File List
_This section will be populated by the development agent during implementation_

---

## QA Results

_This section will be populated by the QA agent during review_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.1 | Added Cancel Scope safety requirements - removed external timeouts, added SDK max_turns protection | Product Owner |
| 2026-01-07 | 1.0 | Initial story creation for Basedpyright Agent Integration | Scrum Master (Bob) |

---
