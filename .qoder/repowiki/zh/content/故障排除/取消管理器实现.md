# å–æ¶ˆç®¡ç†å™¨å®ç°

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [cancellation_manager.py](file://autoBMAD/epic_automation/core/cancellation_manager.py)
- [sdk_cancellation_manager.py](file://autoBMAD/epic_automation/monitoring/sdk_cancellation_manager.py)
- [sdk_wrapper.py](file://autoBMAD/epic_automation/sdk_wrapper.py)
- [cancel_scope_tracker.py](file://BUGFIX_20260107/debug_suite/cancel_scope_tracker.py)
- [resource_monitor.py](file://autoBMAD/epic_automation/monitoring/resource_monitor.py)
- [async_debugger.py](file://BUGFIX_20260107/debug_suite/async_debugger.py)
- [test_cancellation_manager.py](file://tests/unit/test_cancellation_manager.py)
- [CANCEL_SCOPE_CROSS_TASK_FIX.md](file://docs/CANCEL_SCOPE_CROSS_TASK_FIX.md)
- [sdk-cancellation-manager-design.md](file://docs-copy/architecture/sdk-cancellation-manager-design.md)
- [sdk-cancellation-manager-implementation.md](file://docs-copy/architecture/sdk-cancellation-manager-implementation.md)
</cite>

## ç›®å½•
1. [å–æ¶ˆç®¡ç†å™¨æ¦‚è¿°](#å–æ¶ˆç®¡ç†å™¨æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
3. [SDKå–æ¶ˆç®¡ç†å™¨å®ç°](#sdkå–æ¶ˆç®¡ç†å™¨å®ç°)
4. [å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨](#å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨)
5. [èµ„æºç›‘æ§å™¨](#èµ„æºç›‘æ§å™¨)
6. [å¼‚æ­¥è°ƒè¯•å™¨](#å¼‚æ­¥è°ƒè¯•å™¨)
7. [é›†æˆä¸å·¥ä½œæµ](#é›†æˆä¸å·¥ä½œæµ)
8. [æµ‹è¯•ä¸éªŒè¯](#æµ‹è¯•ä¸éªŒè¯)
9. [æ¶æ„å›¾](#æ¶æ„å›¾)
10. [ç»“è®º](#ç»“è®º)

## å–æ¶ˆç®¡ç†å™¨æ¦‚è¿°

å–æ¶ˆç®¡ç†å™¨æ˜¯BMADè‡ªåŠ¨åŒ–ç³»ç»Ÿä¸­çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†SDKè°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸã€å–æ¶ˆè¯·æ±‚å’Œèµ„æºæ¸…ç†ã€‚è¯¥ç³»ç»Ÿè§£å†³äº†AnyIOå–æ¶ˆä½œç”¨åŸŸè·¨ä»»åŠ¡é”™è¯¯çš„é—®é¢˜ï¼Œç¡®ä¿å¼‚æ­¥æ“ä½œçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚å–æ¶ˆç®¡ç†å™¨é‡‡ç”¨åŒæ¡ä»¶éªŒè¯æœºåˆ¶ï¼Œåªæœ‰å½“å–æ¶ˆè¯·æ±‚å’Œæ¸…ç†å®Œæˆä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œæ‰è®¤ä¸ºå¯ä»¥å®‰å…¨è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚

å–æ¶ˆç®¡ç†å™¨çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
- è·Ÿè¸ªæ´»è·ƒçš„SDKè°ƒç”¨
- ç®¡ç†å–æ¶ˆè¯·æ±‚
- éªŒè¯æ¸…ç†å®Œæˆï¼ˆåŒæ¡ä»¶éªŒè¯æœºåˆ¶ï¼‰
- æä¾›å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨`track_sdk_execution`
- ç”Ÿæˆè¯Šæ–­æŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯

è¯¥ç³»ç»Ÿé€šè¿‡å¼•å…¥å¼ºåˆ¶åŒæ­¥ç‚¹å’Œä¼˜åŒ–çš„èµ„æºç®¡ç†ï¼Œè§£å†³äº†è·¨ä»»åŠ¡å–æ¶ˆä½œç”¨åŸŸé”™è¯¯ï¼Œç¡®ä¿äº†Dev-QAå·¥ä½œæµçš„ç¨³å®šæ‰§è¡Œã€‚

**Section sources**
- [cancellation_manager.py](file://autoBMAD/epic_automation/core/cancellation_manager.py)
- [CANCEL_SCOPE_CROSS_TASK_FIX.md](file://docs/CANCEL_SCOPE_CROSS_TASK_FIX.md)

## æ ¸å¿ƒç»„ä»¶åˆ†æ

å–æ¶ˆç®¡ç†å™¨ç³»ç»Ÿç”±å¤šä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£å’ŒåŠŸèƒ½ã€‚è¿™äº›ç»„ä»¶ååŒå·¥ä½œï¼Œç¡®ä¿SDKè°ƒç”¨çš„æ­£ç¡®ç®¡ç†å’Œèµ„æºçš„é€‚å½“æ¸…ç†ã€‚

### CallInfo æ•°æ®ç±»

`CallInfo`æ•°æ®ç±»ç”¨äºå­˜å‚¨SDKè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è°ƒç”¨æ ‡è¯†ã€ä»£ç†åç§°ã€å¼€å§‹æ—¶é—´ã€å–æ¶ˆè¯·æ±‚çŠ¶æ€ã€æ¸…ç†å®ŒæˆçŠ¶æ€ã€æ˜¯å¦å·²æ‰¾åˆ°ç›®æ ‡ç»“æœå’Œé”™è¯¯åˆ—è¡¨ã€‚è¿™ä¸ªæ•°æ®ç±»æ˜¯å–æ¶ˆç®¡ç†å™¨è·Ÿè¸ªå’Œç®¡ç†SDKè°ƒç”¨çš„åŸºç¡€ã€‚

```python
@dataclass
class CallInfo:
    """SDKè°ƒç”¨ä¿¡æ¯æ•°æ®ç±»"""
    call_id: str
    agent_name: str
    start_time: float
    cancel_requested: bool = False
    cleanup_completed: bool = False
    has_target_result: bool = False
    errors: list[str] = field(default_factory=list)
```

### CancellationManager ç±»

`CancellationManager`ç±»æ˜¯å–æ¶ˆç®¡ç†å™¨çš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰æ´»è·ƒçš„SDKè°ƒç”¨ã€‚å®ƒå®ç°äº†åŒæ¡ä»¶éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰åœ¨å–æ¶ˆè¯·æ±‚å’Œæ¸…ç†å®Œæˆéƒ½æ»¡è¶³æ—¶ï¼Œæ‰å…è®¸ç»§ç»­æ‰§è¡Œã€‚è¯¥ç±»æä¾›äº†æ³¨å†Œè°ƒç”¨ã€è¯·æ±‚å–æ¶ˆã€æ ‡è®°æ¸…ç†å®Œæˆã€æ ‡è®°æ‰¾åˆ°ç›®æ ‡ç»“æœç­‰æ–¹æ³•ã€‚

```python
class CancellationManager:
    """
    å–æ¶ˆç®¡ç†å™¨
    
    è´Ÿè´£ç®¡ç†æ‰€æœ‰æ´»è·ƒçš„SDKè°ƒç”¨ï¼Œå®ç°åŒæ¡ä»¶éªŒè¯æœºåˆ¶ï¼š
    1. cancel_requested = True
    2. cleanup_completed = True
    
    åªæœ‰åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰è®¤ä¸ºå¯ä»¥å®‰å…¨è¿›è¡Œä¸‹ä¸€æ­¥ã€‚
    """
```

**Section sources**
- [cancellation_manager.py](file://autoBMAD/epic_automation/core/cancellation_manager.py)

## SDKå–æ¶ˆç®¡ç†å™¨å®ç°

SDKå–æ¶ˆç®¡ç†å™¨æ˜¯å–æ¶ˆç®¡ç†å™¨ç³»ç»Ÿçš„é«˜çº§å®ç°ï¼Œæä¾›äº†æ›´å…¨é¢çš„åŠŸèƒ½å’Œæ›´å¥½çš„é›†æˆã€‚å®ƒæ•´åˆäº†å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨ã€èµ„æºç›‘æ§å™¨å’Œå¼‚æ­¥è°ƒè¯•å™¨ï¼Œæä¾›äº†ç»Ÿä¸€çš„SDKè°ƒç”¨ç®¡ç†ã€‚

### åˆå§‹åŒ–

SDKå–æ¶ˆç®¡ç†å™¨åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºå’Œé…ç½®å„ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬æ—¥å¿—ç›®å½•ã€å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨ã€èµ„æºç›‘æ§å™¨å’Œå¼‚æ­¥è°ƒè¯•å™¨ã€‚å®ƒè¿˜ç»´æŠ¤äº†æ´»è·ƒã€å·²å®Œæˆã€å·²å–æ¶ˆå’Œå¤±è´¥çš„SDKè°ƒç”¨åˆ—è¡¨ï¼Œä»¥åŠç»Ÿè®¡ä¿¡æ¯ã€‚

```python
def __init__(
    self,
    log_dir: Optional[Path] = None,
    enable_tracking: bool = True,
    enable_monitoring: bool = True,
    enable_debugging: bool = True
):
    """
    åˆå§‹åŒ– SDK å–æ¶ˆç®¡ç†å™¨
    
    Args:
        log_dir: æ—¥å¿—ç›®å½•
        enable_tracking: å¯ç”¨ cancel scope è¿½è¸ª
        enable_monitoring: å¯ç”¨èµ„æºç›‘æ§
        enable_debugging: å¯ç”¨å¼‚æ­¥è°ƒè¯•
    """
```

### è·Ÿè¸ªSDKæ‰§è¡Œ

`track_sdk_execution`æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç”¨äºè¿½è¸ªSDKæ‰§è¡Œã€‚å®ƒåœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶è®°å½•SDKè°ƒç”¨çš„å¼€å§‹ï¼Œåœ¨é€€å‡ºæ—¶å¤„ç†æˆåŠŸå®Œæˆã€å–æ¶ˆæˆ–å¤±è´¥çš„æƒ…å†µã€‚è¯¥æ–¹æ³•è¿˜è´Ÿè´£æ¸…ç†å’Œé€€å‡ºå–æ¶ˆä½œç”¨åŸŸã€‚

```python
@asynccontextmanager
async def track_sdk_execution(
    self,
    call_id: str,
    operation_name: str,
    context: Optional[Dict[str, Any]] = None
):
    """
    è¿½è¸ª SDK æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    
    ä½¿ç”¨æ–¹æ³•:
    ```python
    async with manager.track_sdk_execution("parse_status", "status_parsing"):
        result = await sdk.execute()
    ```
    
    Args:
        call_id: è°ƒç”¨å”¯ä¸€æ ‡è¯†
        operation_name: æ“ä½œåç§°
        context: ä¸Šä¸‹æ–‡ä¿¡æ¯
    """
```

### ç¡®è®¤å®‰å…¨ç»§ç»­

`confirm_safe_to_proceed`æ–¹æ³•ç”¨äºç¡®è®¤SDKå¯ä»¥å®‰å…¨ç»§ç»­ã€‚å®ƒæ£€æŸ¥è°ƒç”¨æ˜¯å¦ä»åœ¨æ´»åŠ¨åˆ—è¡¨ä¸­ï¼Œæˆ–æ˜¯å¦åœ¨å–æ¶ˆåˆ—è¡¨ä¸­ä¸”æœªå®Œå…¨æ¸…ç†ã€‚åªæœ‰å½“è°ƒç”¨ä¸åœ¨æ´»åŠ¨åˆ—è¡¨ä¸­ä¸”æ¸…ç†å·²å®Œæˆæ—¶ï¼Œæ‰è¿”å›Trueã€‚

```python
def confirm_safe_to_proceed(self, call_id: str) -> bool:
    """
    ç¡®è®¤ SDK å¯ä»¥å®‰å…¨ç»§ç»­
    
    ğŸ¯ Agent åœ¨ç»§ç»­æ‰§è¡Œå‰å¿…é¡»è°ƒç”¨æ­¤æ–¹æ³•
    
    Args:
        call_id: è°ƒç”¨æ ‡è¯†
        
    Returns:
        True if safe to proceed, False otherwise
    """
```

**Section sources**
- [sdk_cancellation_manager.py](file://autoBMAD/epic_automation/monitoring/sdk_cancellation_manager.py)

## å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨

å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨è´Ÿè´£è¿½è¸ªå–æ¶ˆä½œç”¨åŸŸçš„è¿›å…¥å’Œé€€å‡ºï¼Œæ£€æµ‹è·¨ä»»åŠ¡è®¿é—®ï¼Œè®°å½•ä½œç”¨åŸŸå±‚çº§å…³ç³»ï¼Œå¹¶è¯†åˆ«ä½œç”¨åŸŸæ³„æ¼ã€‚

### èŒè´£

- è¿½è¸ªå–æ¶ˆä½œç”¨åŸŸçš„è¿›å…¥/é€€å‡º
- æ£€æµ‹è·¨ä»»åŠ¡è®¿é—®
- è®°å½•ä½œç”¨åŸŸå±‚çº§å…³ç³»
- è¯†åˆ«ä½œç”¨åŸŸæ³„æ¼

### å…³é”®ç‰¹æ€§

å–æ¶ˆä½œç”¨åŸŸè¿½è¸ªå™¨èƒ½å¤Ÿæ£€æµ‹è·¨ä»»åŠ¡è®¿é—®ï¼Œå½“ä¸€ä¸ªä»»åŠ¡è¿›å…¥å–æ¶ˆä½œç”¨åŸŸè€Œå¦ä¸€ä¸ªä»»åŠ¡é€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è®°å½•é”™è¯¯äº‹ä»¶ã€‚è¿™æœ‰åŠ©äºè¯†åˆ«å’Œè§£å†³è·¨ä»»åŠ¡å–æ¶ˆä½œç”¨åŸŸé”™è¯¯ã€‚

```python
# è·¨ä»»åŠ¡æ£€æµ‹ç¤ºä¾‹
tracker.enter_scope(scope_id="scope_001", name="sdk_execution")
# Task A è¿›å…¥

# ... å¼‚æ­¥æ“ä½œ ...

tracker.exit_scope(scope_id="scope_001")
# Task B é€€å‡º âŒ è·¨ä»»åŠ¡è®¿é—®ï¼

# è‡ªåŠ¨è®°å½•é”™è¯¯äº‹ä»¶
{
    "event_type": "error",
    "error_type": "cross_task_access",
    "scope_id": "scope_001",
    "entered_by_task": "Task-12345",
    "exited_by_task": "Task-67890",
    "stack_trace": "..."
}
```

**Section sources**
- [cancel_scope_tracker.py](file://BUGFIX_20260107/debug_suite/cancel_scope_tracker.py)
- [sdk-cancellation-manager-design.md](file://docs-copy/architecture/sdk-cancellation-manager-design.md)

## èµ„æºç›‘æ§å™¨

èµ„æºç›‘æ§å™¨è´Ÿè´£ç›‘æ§ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬é”ã€ä¼šè¯ã€ä»»åŠ¡ç­‰èµ„æºçš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚

### èŒè´£

- ç›‘æ§é”çš„è·å–/é‡Šæ”¾
- è¿½è¸ªSDKä¼šè¯ç”Ÿå‘½å‘¨æœŸ
- æ£€æµ‹èµ„æºæ³„æ¼
- ç»Ÿè®¡èµ„æºä½¿ç”¨æƒ…å†µ

### ç»„ä»¶

èµ„æºç›‘æ§å™¨ç”±å¤šä¸ªå­ç»„ä»¶æ„æˆï¼ŒåŒ…æ‹¬é”ç›‘æ§å™¨ã€ä¼šè¯ç›‘æ§å™¨ã€ä»»åŠ¡ç›‘æ§å™¨å’Œç³»ç»Ÿç›‘æ§å™¨ã€‚æ¯ä¸ªå­ç»„ä»¶è´Ÿè´£ç›‘æ§ç‰¹å®šç±»å‹çš„èµ„æºã€‚

```python
class ResourceMonitor:
    """èµ„æºç›‘æ§å™¨ä¸»ç±»"""
    
    def __init__(self, log_file: Optional[Path] = None):
        self.lock_monitor = LockMonitor()
        self.session_monitor = SessionMonitor()
        self.task_monitor = TaskMonitor()
        self.system_monitor = SystemMonitor()
```

**Section sources**
- [resource_monitor.py](file://autoBMAD/epic_automation/monitoring/resource_monitor.py)
- [sdk-cancellation-manager-design.md](file://docs-copy/architecture/sdk-cancellation-manager-design.md)

## å¼‚æ­¥è°ƒè¯•å™¨

å¼‚æ­¥è°ƒè¯•å™¨ç”¨äºè°ƒè¯•å¼‚æ­¥æ“ä½œï¼Œæä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œè°ƒè¯•ä¿¡æ¯ã€‚

### èŒè´£

- æä¾›å¼‚æ­¥æ“ä½œçš„è¯¦ç»†æ—¥å¿—
- è®°å½•å¼‚æ­¥ç”Ÿæˆå™¨çš„ç”Ÿå‘½å‘¨æœŸ
- æ•è·å’ŒæŠ¥å‘Šå¼‚æ­¥é”™è¯¯
- æä¾›è°ƒè¯•ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª

### å®ç°

å¼‚æ­¥è°ƒè¯•å™¨é€šè¿‡è®°å½•å¼‚æ­¥æ“ä½œçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä»¥åŠæ•è·å’ŒæŠ¥å‘Šä»»ä½•å¼‚å¸¸ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å’Œè°ƒè¯•å¼‚æ­¥ä»£ç ã€‚

```python
class AsyncDebugger:
    """å¼‚æ­¥è°ƒè¯•å™¨"""
    
    def __init__(self, log_file: Path):
        self.log_file = log_file
        self.logger = self._setup_logging()
```

**Section sources**
- [async_debugger.py](file://BUGFIX_20260107/debug_suite/async_debugger.py)

## é›†æˆä¸å·¥ä½œæµ

å–æ¶ˆç®¡ç†å™¨ç³»ç»Ÿä¸BMADè‡ªåŠ¨åŒ–ç³»ç»Ÿçš„å…¶ä»–ç»„ä»¶ç´§å¯†é›†æˆï¼Œç¡®ä¿æ•´ä¸ªå·¥ä½œæµçš„ç¨³å®šå’Œé«˜æ•ˆã€‚

### ä¸SDKåŒ…è£…å™¨çš„é›†æˆ

SDKåŒ…è£…å™¨é›†æˆäº†SDKå–æ¶ˆç®¡ç†å™¨ï¼Œç¡®ä¿æ‰€æœ‰SDKè°ƒç”¨éƒ½é€šè¿‡ç®¡ç†å™¨è¿›è¡Œè¿½è¸ªã€‚è¿™è§£å†³äº†å–æ¶ˆä½œç”¨åŸŸè·¨ä»»åŠ¡é”™è¯¯ï¼Œå¹¶æä¾›äº†ç»Ÿä¸€çš„å–æ¶ˆå¤„ç†æœºåˆ¶ã€‚

```python
class SafeClaudeSDK:
    """
    Fixed safe wrapper for Claude SDK with unified cancellation management.
    
    This wrapper ensures proper cleanup of async generators and prevents
    RuntimeError when event loop closes. Now integrated with SDKCancellationManager
    for unified cancellation handling.
    """
```

### å·¥ä½œæµ

å–æ¶ˆç®¡ç†å™¨çš„å·¥ä½œæµåŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š
1. æ³¨å†ŒSDKè°ƒç”¨
2. æ‰§è¡ŒSDKæ“ä½œ
3. å¤„ç†æˆåŠŸå®Œæˆã€å–æ¶ˆæˆ–å¤±è´¥
4. æ¸…ç†èµ„æº
5. ç¡®è®¤å®‰å…¨ç»§ç»­

**Section sources**
- [sdk_wrapper.py](file://autoBMAD/epic_automation/sdk_wrapper.py)
- [sdk_cancellation_manager.py](file://autoBMAD/epic_automation/monitoring/sdk_cancellation_manager.py)

## æµ‹è¯•ä¸éªŒè¯

å–æ¶ˆç®¡ç†å™¨ç³»ç»Ÿç»è¿‡äº†å…¨é¢çš„æµ‹è¯•å’ŒéªŒè¯ï¼Œç¡®ä¿å…¶åŠŸèƒ½çš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚

### å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•è¦†ç›–äº†å–æ¶ˆç®¡ç†å™¨çš„æ‰€æœ‰ä¸»è¦åŠŸèƒ½ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€æ³¨å†Œè°ƒç”¨ã€è¯·æ±‚å–æ¶ˆã€æ ‡è®°æ¸…ç†å®Œæˆã€æ ‡è®°æ‰¾åˆ°ç›®æ ‡ç»“æœå’Œç¡®è®¤å®‰å…¨ç»§ç»­ã€‚

```python
@pytest.mark.anyio
class TestCancellationManager:
    """æµ‹è¯• CancellationManager ç±»"""
    
    @pytest.fixture
    def manager(self):
        """åˆ›å»º CancellationManager å®ä¾‹"""
        return CancellationManager()
```

### é›†æˆæµ‹è¯•

é›†æˆæµ‹è¯•éªŒè¯äº†å–æ¶ˆç®¡ç†å™¨ä¸å…¶ä»–ç»„ä»¶çš„åä½œï¼ŒåŒ…æ‹¬SDKåŒ…è£…å™¨ã€çŠ¶æ€ç®¡ç†å™¨å’Œè´¨é‡é—¨æ§ã€‚

```python
@pytest.mark.integration
@pytest.mark.anyio
async def test_state_machine_with_failed_state_recovery(safe_task_group, temp_story_file):
    """æµ‹è¯•çŠ¶æ€æœºå¤±è´¥çŠ¶æ€æ¢å¤"""
```

**Section sources**
- [test_cancellation_manager.py](file://tests/unit/test_cancellation_manager.py)

## æ¶æ„å›¾

```mermaid
graph TD
subgraph "SDK Cancellation Manager"
subgraph "Core Components"
CancelScopeTracker[Cancel Scope Tracker]
ResourceMonitor[Resource Monitor]
AsyncDebugger[Async Debugger]
EventAggregator[Event Aggregator]
end
subgraph "Management Layer"
SDKCallTracking[SDK Call Tracking]
ResultCaching[Result Caching]
CancellationDetection[Cancellation Detection]
CrossTaskValidation[Cross-task Validation]
CleanupCoordination[Cleanup Coordination]
ReportGeneration[Report Generation]
end
end
IntegrationPoints[Integration Points]
CancelScopeTracker --> ManagementLayer
ResourceMonitor --> ManagementLayer
AsyncDebugger --> ManagementLayer
EventAggregator --> ManagementLayer
ManagementLayer --> IntegrationPoints
IntegrationPoints --> SafeClaudeSDK[SafeClaudeSDK]
IntegrationPoints --> DevAgent[DevAgent / QAAgent / SMAgent]
IntegrationPoints --> StateManager[StateManager]
IntegrationPoints --> EpicDriver[EpicDriver]
```

**Diagram sources**
- [sdk-cancellation-manager-design.md](file://docs-copy/architecture/sdk-cancellation-manager-design.md)

## ç»“è®º

å–æ¶ˆç®¡ç†å™¨å®ç°æˆåŠŸè§£å†³äº†AnyIOå–æ¶ˆä½œç”¨åŸŸè·¨ä»»åŠ¡é”™è¯¯çš„é—®é¢˜ï¼Œç¡®ä¿äº†BMADè‡ªåŠ¨åŒ–ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚é€šè¿‡å¼•å…¥åŒæ¡ä»¶éªŒè¯æœºåˆ¶ã€å¼ºåˆ¶åŒæ­¥ç‚¹å’Œä¼˜åŒ–çš„èµ„æºç®¡ç†ï¼Œè¯¥ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå¥å£®çš„SDKè°ƒç”¨ç®¡ç†æ¡†æ¶ã€‚

ä¸»è¦æˆæœåŒ…æ‹¬ï¼š
- è§£å†³äº†å–æ¶ˆä½œç”¨åŸŸè·¨ä»»åŠ¡é”™è¯¯
- å®ç°äº†ç»Ÿä¸€çš„SDKè°ƒç”¨ç®¡ç†
- æä¾›äº†è¯¦ç»†çš„è¯Šæ–­æŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯
- å¢å¼ºäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§

æœªæ¥çš„å·¥ä½œå¯ä»¥åŒ…æ‹¬è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½ã€å¢åŠ æ›´å¤šçš„ç›‘æ§æŒ‡æ ‡å’Œæ”¹è¿›é”™è¯¯æ¢å¤æœºåˆ¶ã€‚