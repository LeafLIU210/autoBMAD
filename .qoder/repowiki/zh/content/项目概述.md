# 项目概述

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [autoBMAD/epic_automation/__init__.py](file://autoBMAD/epic_automation/__init__.py)
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py)
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py)
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py)
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py)
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py)
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py)
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
pytQt_template项目是一个名为autoBMAD（突破性敏捷AI驱动开发方法）的智能自动化系统，旨在通过一个完整的五阶段工作流处理史诗级任务（epics），并集成代码质量门控和测试自动化。该项目的核心目标是实现后端自动化，通过SM-Dev-QA循环自动化处理史诗级任务，并集成Ruff、BasedPyright和Pytest质量门控，从而提升开发效率和代码质量。

autoBMAD系统通过一个集成的5阶段工作流来处理史诗级任务，包括SM-Dev-QA循环、质量门控、测试自动化、编排和文档与集成。该系统利用异步处理、状态管理和调试集成等核心设计理念，确保在软件开发生命周期中高效运行。项目不仅为初学者提供了高层次的概念性理解，也为高级开发者提供了技术深度，包括系统边界、主要组件交互和预期使用场景。

**Section sources**
- [README.md](file://README.md#L7-L134)

## 项目结构
pytQt_template项目的目录结构清晰，分为多个模块和子目录，以支持其复杂的自动化功能。项目根目录包含主要的配置文件、测试文件和文档，而`autoBMAD`目录则包含了核心的自动化逻辑。

项目的主要目录包括：
- `BUGFIX_20260107/`：包含调试和修复相关的配置和脚本。
- `autoBMAD/`：核心自动化模块，包含史诗级任务处理、规范自动化和日志管理。
- `bmad-docs/`：详细的文档，涵盖核心概念、模块和工作流。
- `claude_docs/`：与Claude AI相关的文档，包括工作流、方法论和开发规则。
- `docs/`：项目文档，包括史诗、故事和验证报告。
- `spec_automation/`：规范自动化模块，用于生成和验证测试规范。
- `src/`：源代码，包括气泡排序算法和命令行接口。
- `tests/`：测试文件，确保代码质量和功能正确性。

这种结构化的布局使得项目易于维护和扩展，同时也便于开发者快速定位和理解各个组件的功能。

```mermaid
graph TD
subgraph "根目录"
README[README.md]
pyproject[pyproject.toml]
requirements[requirements.txt]
src[src/]
tests[tests/]
docs[docs/]
autoBMAD[autoBMAD/]
bmad_docs[bmad-docs/]
claude_docs[claude_docs/]
end
subgraph "autoBMAD"
epic_automation[epic_automation/]
spec_automation[spec_automation/]
end
subgraph "epic_automation"
agents[agents.py]
dev_agent[dev_agent.py]
qa_agent[qa_agent.py]
sm_agent[sm_agent.py]
state_manager[state_manager.py]
story_parser[story_parser.py]
epic_driver[epic_driver.py]
sdk_session_manager[sdk_session_manager.py]
end
subgraph "spec_automation"
spec_generator[spec_generator.py]
spec_parser[spec_parser.py]
spec_validator[spec_validator.py]
end
README --> autoBMAD
pyproject --> autoBMAD
requirements --> autoBMAD
src --> autoBMAD
tests --> autoBMAD
docs --> autoBMAD
bmad_docs --> autoBMAD
claude_docs --> autoBMAD
autoBMAD --> epic_automation
autoBMAD --> spec_automation
epic_automation --> agents
epic_automation --> dev_agent
epic_automation --> qa_agent
epic_automation --> sm_agent
epic_automation --> state_manager
epic_automation --> story_parser
epic_automation --> epic_driver
epic_automation --> sdk_session_manager
spec_automation --> spec_generator
spec_automation --> spec_parser
spec_automation --> spec_validator
```

**Diagram sources**
- [README.md](file://README.md#L63-L134)
- [pyproject.toml](file://pyproject.toml#L1-L110)

**Section sources**
- [README.md](file://README.md#L63-L134)
- [pyproject.toml](file://pyproject.toml#L1-L110)

## 核心组件
pytQt_template项目的核心组件包括`epic_driver.py`、`state_manager.py`、`dev_agent.py`、`qa_agent.py`、`sm_agent.py`、`sdk_session_manager.py`和`story_parser.py`。这些组件共同协作，实现了从史诗级任务解析到自动化处理的完整流程。

`epic_driver.py`是系统的主要编排器，负责管理整个工作流的执行，包括SM-Dev-QA循环、质量门控和测试自动化。`state_manager.py`使用SQLite数据库跟踪故事的进度，确保状态的一致性和持久性。`dev_agent.py`和`qa_agent.py`分别负责开发和质量保证任务，通过与Claude SDK集成实现自动化。`sm_agent.py`负责故事的创建和管理，确保史诗级任务的正确分解。`sdk_session_manager.py`和`story_parser.py`则提供了SDK会话管理和故事解析的功能，确保系统的稳定性和可靠性。

**Section sources**
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py#L1-L800)
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py#L1-L800)
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py#L1-L800)
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py#L1-L760)
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py#L1-L440)
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py#L1-L800)

## 架构概述
pytQt_template项目的架构设计围绕着一个中心化的编排器`epic_driver`，它协调多个代理（agents）和工具，实现从史诗级任务到具体实现的自动化流程。系统的核心是SM-Dev-QA循环，其中故事大师（Story Master, SM）代理创建故事，开发（Dev）代理实现功能，质量保证（QA）代理进行审查。

整个工作流分为五个阶段：SM-Dev-QA循环、质量门控、测试自动化、编排和文档与集成。每个阶段都有明确的输入和输出，确保流程的顺畅和可追溯性。质量门控阶段集成了Ruff、BasedPyright和Pytest，确保代码质量和测试覆盖率。编排阶段由`epic_driver`管理，确保所有阶段按顺序执行，并处理阶段间的依赖关系。

```mermaid
graph TD
subgraph "阶段1: SM-Dev-QA循环"
SM[故事大师代理]
Dev[开发代理]
QA[质量保证代理]
SM --> Dev
Dev --> QA
QA --> SM
end
subgraph "阶段2: 质量门控"
Ruff[Ruff - 代码格式化]
BasedPyright[BasedPyright - 类型检查]
Ruff --> BasedPyright
end
subgraph "阶段3: 测试自动化"
Pytest[Pytest - 测试执行]
Debugpy[Debugpy - 调试]
Pytest --> Debugpy
end
subgraph "阶段4: 编排"
EpicDriver[史诗驱动器]
end
subgraph "阶段5: 文档与集成"
AutoDoc[自动生成文档]
IntegrationTest[集成测试]
end
SM --> Ruff
BasedPyright --> Pytest
Debugpy --> EpicDriver
EpicDriver --> AutoDoc
AutoDoc --> IntegrationTest
```

**Diagram sources**
- [README.md](file://README.md#L63-L134)
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)

## 详细组件分析
### 史诗驱动器分析
`epic_driver.py`是pytQt_template项目的核心组件，负责管理整个自动化工作流。它通过解析史诗级任务文档，提取故事信息，并协调SM-Dev-QA循环的执行。`epic_driver`还负责质量门控和测试自动化的执行，确保代码质量和测试覆盖率。

`epic_driver`的主要功能包括：
- 解析史诗级任务文档，提取故事ID和相关信息。
- 协调SM-Dev-QA循环，确保故事的正确创建、实现和审查。
- 执行质量门控，包括Ruff、BasedPyright和Pytest。
- 管理测试自动化，确保所有测试通过。
- 生成文档和集成测试，确保系统的完整性和一致性。

```mermaid
classDiagram
class EpicDriver {
+str epic_path
+str epic_id
+Path tasks_dir
+list[dict[str, Any]] stories
+int current_story_index
+int max_iterations
+bool retry_failed
+bool verbose
+bool concurrent
+bool use_claude
+str source_dir
+str test_dir
+Any sm_agent
+Any dev_agent
+Any qa_agent
+Any state_manager
+logging.Logger logger
+LogManager log_manager
+__init__(epic_path : str, tasks_dir : str, max_iterations : int, retry_failed : bool, verbose : bool, concurrent : bool, use_claude : bool, source_dir : str, test_dir : str, skip_quality : bool, skip_tests : bool)
+_setup_logging() logging.Logger
+parse_epic() list[dict[str, Any]]
+run() None
}
class QualityGateOrchestrator {
+str source_dir
+str test_dir
+bool skip_quality
+bool skip_tests
+logging.Logger logger
+dict[str, Any] results
+__init__(source_dir : str, test_dir : str, skip_quality : bool, skip_tests : bool)
+_update_progress(phase : str, status : str, start : bool, end : bool) None
+_calculate_duration(start_time : float, end_time : float) float
+execute_ruff_agent(source_dir : str) dict[str, Any]
+execute_basedpyright_agent(source_dir : str) dict[str, Any]
+execute_pytest_agent(test_dir : str) dict[str, Any]
+execute_quality_gates(epic_id : str) dict[str, Any]
+_finalize_results() dict[str, Any]
}
EpicDriver --> QualityGateOrchestrator : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)

### 状态管理器分析
`state_manager.py`是pytQt_template项目中的关键组件，负责跟踪和管理故事的进度。它使用SQLite数据库存储故事的状态信息，包括史诗路径、故事路径、状态、迭代次数、QA结果、错误消息、创建和更新时间、阶段和版本。

`state_manager`的主要功能包括：
- 初始化数据库模式，确保表和索引的正确创建。
- 更新和获取故事状态，支持乐观锁和死锁检测。
- 提供数据库连接池，提高并发性能。
- 创建数据库备份和清理旧记录，确保数据的完整性和性能。

```mermaid
classDiagram
class StateManager {
+Path db_path
+asyncio.Lock _lock
+DeadlockDetector _deadlock_detector
+DatabaseConnectionPool | None _connection_pool
+__init__(db_path : str, use_connection_pool : bool)
+_init_db_sync() None
+_get_db_connection() asynccontextmanager
+update_story_status(story_path : str, status : str, phase : str | None, iteration : int | None, qa_result : Union[dict[str, Any], None], error : str | None, epic_path : str | None, lock_timeout : float, expected_version : int | None) tuple[bool, int | None]
+_update_story_internal(story_path : str, status : str, phase : str | None, iteration : int | None, qa_result : Union[dict[str, Any], None], error : str | None, epic_path : str | None, expected_version : int | None) tuple[bool, int | None]
+_clean_qa_result_for_json(qa_result : Any) str | None
+managed_operation() asynccontextmanager
+get_story_status(story_path : str) Union[dict[str, Any], None]
+get_all_stories() list[dict[str, Any]]
+get_stats() dict[str, int]
+create_backup() str | None
+cleanup_old_records(days : int) int
+get_health_status() dict[str, Any]
+sync_story_statuses_to_markdown() dict[str, Any]
+_update_markdown_status(story_path : str, db_status : str) None
+_find_actual_story_file(db_story_path : str) Path | None
}
class DeadlockDetector {
+dict[str, asyncio.Task[None]] lock_waiters
+float lock_timeout
+bool deadlock_detected
+__init__()
+wait_for_lock(lock_name : str, lock : asyncio.Lock) bool
}
class DatabaseConnectionPool {
+int max_connections
+asyncio.Queue[sqlite3.Connection] connections
+dict[str, Any] connection_params
+__init__(max_connections : int)
+initialize(db_path : Path) None
+get_connection() sqlite3.Connection
+return_connection(conn : sqlite3.Connection) None
}
StateManager --> DeadlockDetector : "使用"
StateManager --> DatabaseConnectionPool : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py#L1-L800)

### 开发代理分析
`dev_agent.py`是pytQt_template项目中的开发代理，负责实现故事中的功能。它通过与Claude SDK集成，自动执行开发任务，并确保代码质量和测试覆盖率。

`dev_agent`的主要功能包括：
- 初始化开发代理，配置日志和会话管理。
- 执行开发任务，包括代码生成和测试。
- 处理QA反馈，根据QA代理的建议进行代码修复。
- 通知QA代理进行审查，确保代码质量。

```mermaid
classDiagram
class DevAgent {
+str name
+bool use_claude
+bool _claude_available
+SDKSessionManager _session_manager
+LogManager | None _log_manager
+str | None _current_story_path
+SimpleStoryParser | None status_parser
+__init__(use_claude : bool, log_manager : LogManager | None)
+_validate_prompt_format(prompt : str) bool
+_check_claude_available() bool
+execute(story_path : str) bool
+_extract_requirements(story_content : str) dict[str, Any]
+_validate_requirements(requirements : dict[str, Any]) dict[str, Any]
+_execute_development_tasks(requirements : dict[str, Any]) bool
+_handle_qa_feedback(qa_prompt : str, story_path : str) bool
+_execute_single_claude_sdk(prompt : str, story_path : str, log_manager : LogManager | None) bool
+_notify_qa_agent(story_path : str) dict[str, Any] | None
+_update_story_completion(story_content : str, requirements : dict[str, Any]) None
+_check_story_status(story_path : str) str | None
}
DevAgent --> SDKSessionManager : "使用"
DevAgent --> SimpleStoryParser : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py#L1-L800)

### 质量保证代理分析
`qa_agent.py`是pytQt_template项目中的质量保证代理，负责审查开发代理生成的代码，并确保其符合质量标准。它通过与Claude SDK集成，自动执行QA检查，并生成详细的报告。

`qa_agent`的主要功能包括：
- 初始化QA代理，配置日志和会话管理。
- 执行QA审查，包括代码质量和测试覆盖率。
- 处理开发反馈，根据开发代理的建议进行代码修复。
- 生成QA报告，确保代码质量。

```mermaid
classDiagram
class QAAgent {
+str name
+SDKSessionManager _session_manager
+SimpleStoryParser | None status_parser
+__init__()
+_parse_story_status(story_path : str) str
+execute(story_path : str, cached_status : str | None) dict[str, str | bool | list[str] | int | None]
+execute_qa_phase(story_path : str, source_dir : str, test_dir : str, cached_status : str | None) bool
+_execute_qa_review(story_path : str, source_dir : str, test_dir : str) QAResult
+_execute_ai_qa_review(story_path : str) bool
+_build_qa_prompt(story_path : str) str
+_create_sdk_execution_function(prompt : str) Callable
+_check_story_status(story_path : str) bool
+_evaluate_story_status(status : str) bool
+_perform_fallback_qa_review(story_path : str, source_dir : str, test_dir : str) QAResult
+_check_code_quality_basics(story_path : str) dict[str, Any]
+_check_test_files_exist(story_path : str) dict[str, Any]
+_check_documentation_updated(story_path : str) dict[str, Any]
}
class QAResult {
+bool passed
+bool completed
+bool needs_fix
+str | None dev_prompt
+bool fallback_review
+int checks_passed
+int total_checks
+str | None reason
+__init__(passed : bool, completed : bool, needs_fix : bool, dev_prompt : str | None, fallback_review : bool, checks_passed : int, total_checks : int, reason : str | None)
+to_dict() dict[str, Any]
}
QAAgent --> SDKSessionManager : "使用"
QAAgent --> SimpleStoryParser : "使用"
QAAgent --> QAResult : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py#L1-L800)

### 故事大师代理分析
`sm_agent.py`是pytQt_template项目中的故事大师代理，负责创建和管理故事。它通过与Claude SDK集成，自动创建故事，并确保其符合史诗级任务的要求。

`sm_agent`的主要功能包括：
- 初始化故事大师代理，配置日志和会话管理。
- 创建故事，包括标题、描述和验收标准。
- 验证故事结构，确保其完整性和一致性。
- 更新故事状态，确保其正确流转。

```mermaid
classDiagram
class SMAgent {
+str name
+str agent_name
+str phase
+Path | None project_root
+Path | None tasks_path
+dict[str, Any] config
+SimpleStoryParser | None status_parser
+__init__(project_root : str | None, tasks_path : str | None, config : dict[str, Any] | None)
+_find_story_file(stories_dir : Path, story_id : str) Path | None
+execute(story_content : str, story_path : str) bool
+_parse_story_metadata(story_content : str) dict[str, Any] | None
+_validate_story_structure(story_data : dict[str, Any]) dict[str, Any]
+create_story(title : str, description : str, epic_path : str) dict[str, Any] | None
+create_stories_from_epic(epic_path : str) bool
+_extract_story_ids_from_epic(content : str) list[str]
+_call_claude_create_stories(epic_path : str, story_ids : list[str]) bool
+_build_claude_prompt(epic_path : str, story_ids : list[str]) str
+_execute_claude_sdk(prompt : str) bool
+_execute_sdk_with_logging(prompt : str) bool
+_verify_story_files(story_ids : list[str], epic_path : str) tuple[bool, list[str]]
+_update_story_statuses(story_ids : list[str], stories_dir : Path) None
+_check_existing_stories(epic_path : str, story_ids : list[str]) bool
}
SMAgent --> SimpleStoryParser : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py#L1-L760)

**Section sources**
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py#L1-L760)

### SDK会话管理器分析
`sdk_session_manager.py`是pytQt_template项目中的SDK会话管理器，负责管理与Claude SDK的会话。它通过隔离的执行上下文，确保会话的独立性和安全性。

`sdk_session_manager`的主要功能包括：
- 创建隔离的SDK会话，确保会话的独立性。
- 执行SDK调用，处理超时和重试。
- 管理会话生命周期，确保会话的正确创建和销毁。
- 提供会话健康检查，确保会话的稳定性。

```mermaid
classDiagram
class SDKSessionManager {
+dict[str, IsolatedSDKContext] _active_sessions
+asyncio.Lock _lock
+int _total_sessions
+int _successful_sessions
+int _failed_sessions
+dict[str, Any] _retry_config
+__init__()
+create_session(agent_name : str) asynccontextmanager
+execute_isolated(agent_name : str, sdk_func : Callable[[], Any], timeout : float | None, max_retries : int | None) SDKExecutionResult
+_calculate_retry_delay(retry_count : int) float
+get_active_sessions() list[str]
+get_session_count() int
+get_statistics() dict[str, Any]
+cancel_all_sessions() int
+get_session_health_summary() dict[str, Any]
}
class IsolatedSDKContext {
+str agent_name
+str session_id
+asyncio.Event _cancel_event
+bool _is_active
+float | None _start_time
+SessionHealthChecker _health_checker
+__aenter__() IsolatedSDKContext
+__aexit__(exc_type : type | None, exc_val : BaseException | None, exc_tb : Any) bool
+request_cancel() None
+is_cancelled() bool
+is_active() bool
+get_elapsed_time() float
+check_health() bool
}
class SessionHealthChecker {
+dict[str, list[dict[str, Any]]] health_history
+int failure_threshold
+int recovery_threshold
+__init__()
+check_session_health(session_id : str) bool
+record_health_check(session_id : str, healthy : bool, details : dict[str, Any] | None) None
+is_session_recovering(session_id : str) bool
}
class SDKExecutionResult {
+bool success
+SDKErrorType error_type
+str | None error_message
+float duration_seconds
+str session_id
+int retry_count
+BaseException | None last_error
+__init__(success : bool, error_type : SDKErrorType, error_message : str | None, duration_seconds : float, session_id : str, retry_count : int, last_error : BaseException | None)
+is_cancelled() bool
+is_timeout() bool
+is_retryable_error() bool
}
class SDKErrorType {
+str SUCCESS
+str TIMEOUT
+str CANCELLED
+str SDK_ERROR
+str SESSION_ERROR
+str NETWORK_ERROR
+str AUTHENTICATION_ERROR
+str UNKNOWN
}
SDKSessionManager --> IsolatedSDKContext : "使用"
SDKSessionManager --> SessionHealthChecker : "使用"
SDKSessionManager --> SDKExecutionResult : "使用"
SDKSessionManager --> SDKErrorType : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py#L1-L440)

**Section sources**
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py#L1-L440)

### 故事解析器分析
`story_parser.py`是pytQt_template项目中的故事解析器，负责解析故事和史诗级任务文档。它通过AI优先、正则回退的策略，确保解析的准确性和可靠性。

`story_parser`的主要功能包括：
- 初始化故事解析器，配置SDK包装器。
- 解析故事状态，使用AI和正则表达式。
- 解析故事文档，提取标题、状态、验收标准等信息。
- 解析史诗级任务文档，提取故事ID列表。

```mermaid
classDiagram
class SimpleStoryParser {
+SafeClaudeSDK | None sdk_wrapper
+__init__(sdk_wrapper : SafeClaudeSDK | None)
+parse_status(content : str) str
+_regex_fallback_parse_status(content : str) str
+_clean_response_string(response : str) str
+_extract_status_from_response(response : str) str
+_simple_fallback_match(cleaned : str) str
+parse_story(content : str) StoryData
+_ai_parse_story(content : str) StoryData
+_parse_story_json(response : str, original_content : str) StoryData
+_regex_parse_story(content : str) StoryData
+parse_epic(content : str) EpicData
+_ai_parse_epic(content : str) EpicData
+_parse_epic_json(response : str, original_content : str) EpicData
+_regex_parse_epic(content : str) EpicData
}
class StoryData {
+str title
+str status
+list[str] acceptance_criteria
+list[str] tasks
+list[str] subtasks
+str dev_notes
+str testing
+str raw_content
+__init__(title : str, status : str, acceptance_criteria : list[str], tasks : list[str], subtasks : list[str], dev_notes : str, testing : str, raw_content : str)
}
class EpicData {
+str title
+list[str] story_ids
+str raw_content
+__init__(title : str, story_ids : list[str], raw_content : str)
}
class ProcessingStatus {
+str PENDING
+str IN_PROGRESS
+str REVIEW
+str COMPLETED
+str FAILED
+str CANCELLED
+str QA_PASS
+str QA_CONCERNS
+str QA_FAIL
+str QA_WAIVED
+str ERROR
+str UNKNOWN
}
SimpleStoryParser --> StoryData : "使用"
SimpleStoryParser --> EpicData : "使用"
SimpleStoryParser --> ProcessingStatus : "使用"
```

**Diagram sources**
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py#L1-L800)

## 依赖分析
pytQt_template项目的依赖关系复杂，涉及多个模块和外部工具。核心依赖包括`epic_driver`、`state_manager`、`dev_agent`、`qa_agent`、`sm_agent`、`sdk_session_manager`和`story_parser`。这些组件通过`__init__.py`文件进行集成，确保系统的模块化和可维护性。

`epic_driver`依赖于`state_manager`、`dev_agent`、`qa_agent`和`sm_agent`，通过这些代理实现SM-Dev-QA循环。`state_manager`依赖于`DeadlockDetector`和`DatabaseConnectionPool`，确保数据库操作的稳定性和性能。`dev_agent`和`qa_agent`依赖于`SDKSessionManager`和`SimpleStoryParser`，确保与Claude SDK的集成和故事解析的准确性。`sm_agent`依赖于`SimpleStoryParser`，确保故事的正确创建和管理。

```mermaid
graph TD
epic_driver[epic_driver.py] --> state_manager[state_manager.py]
epic_driver --> dev_agent[dev_agent.py]
epic_driver --> qa_agent[qa_agent.py]
epic_driver --> sm_agent[sm_agent.py]
state_manager --> DeadlockDetector
state_manager --> DatabaseConnectionPool
dev_agent --> SDKSessionManager
dev_agent --> SimpleStoryParser
qa_agent --> SDKSessionManager
qa_agent --> SimpleStoryParser
sm_agent --> SimpleStoryParser
SDKSessionManager --> IsolatedSDKContext
SDKSessionManager --> SessionHealthChecker
SDKSessionManager --> SDKExecutionResult
SDKSessionManager --> SDKErrorType
SimpleStoryParser --> StoryData
SimpleStoryParser --> EpicData
SimpleStoryParser --> ProcessingStatus
```

**Diagram sources**
- [autoBMAD/epic_automation/__init__.py](file://autoBMAD/epic_automation/__init__.py#L1-L63)
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py#L1-L800)
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py#L1-L800)
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py#L1-L800)
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py#L1-L760)
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py#L1-L440)
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py#L1-L800)

**Section sources**
- [autoBMAD/epic_automation/__init__.py](file://autoBMAD/epic_automation/__init__.py#L1-L63)
- [autoBMAD/epic_automation/epic_driver.py](file://autoBMAD/epic_automation/epic_driver.py#L1-L800)
- [autoBMAD/epic_automation/state_manager.py](file://autoBMAD/epic_automation/state_manager.py#L1-L800)
- [autoBMAD/epic_automation/dev_agent.py](file://autoBMAD/epic_automation/dev_agent.py#L1-L800)
- [autoBMAD/epic_automation/qa_agent.py](file://autoBMAD/epic_automation/qa_agent.py#L1-L800)
- [autoBMAD/epic_automation/sm_agent.py](file://autoBMAD/epic_automation/sm_agent.py#L1-L760)
- [autoBMAD/epic_automation/sdk_session_manager.py](file://autoBMAD/epic_automation/sdk_session_manager.py#L1-L440)
- [autoBMAD/epic_automation/story_parser.py](file://autoBMAD/epic_automation/story_parser.py#L1-L800)

## 性能考虑
pytQt_template项目在设计时充分考虑了性能因素，通过异步处理、数据库连接池和会话健康检查等机制，确保系统的高效运行。`state_manager`使用SQLite数据库连接池，提高了并发性能。`sdk_session_manager`通过隔离的执行上下文和会话健康检查，确保了会话的稳定性和可靠性。

此外，`epic_driver`通过并行执行多个任务，减少了整体处理时间。`dev_agent`和`qa_agent`通过与Claude SDK的集成，实现了高效的代码生成和审查。`sm_agent`通过批量创建故事，减少了与外部工具的交互次数。

## 故障排除指南
在使用pytQt_template项目时，可能会遇到一些常见问题。以下是一些故障排除建议：

- **质量门控失败**：检查Ruff、BasedPyright和Pytest的配置，确保它们正确安装和配置。运行`ruff check --fix src/`和`basedpyright src/`来修复常见问题。
- **测试失败**：运行`pytest tests/ -v --tb=long`来获取详细的测试输出，检查测试用例和代码逻辑。
- **安装问题**：重新创建虚拟环境并安装依赖项，确保所有依赖项正确安装。
- **取消范围错误**：这些错误是预期的，并且被系统自动处理。无需用户干预，系统会继续正常执行。

**Section sources**
- [README.md](file://README.md#L562-L612)

## 结论
pytQt_template项目通过一个集成的五阶段工作流，实现了从史诗级任务到具体实现的自动化处理。系统的核心是SM-Dev-QA循环，通过`epic_driver`、`state_manager`、`dev_agent`、`qa_agent`、`sm_agent`、`sdk_session_manager`和`story_parser`等组件的协同工作，确保了代码质量和开发效率。项目的设计考虑了性能和可靠性，通过异步处理、数据库连接池和会话健康检查等机制，确保了系统的高效运行。对于初学者，项目提供了高层次的概念性理解；对于高级开发者，项目提供了技术深度，包括系统边界、主要组件交互和预期使用场景。